---
title: "Projections"
author: Michael_T_Hallworth
dateCreated: 2018-02-20
modified: 2018-03-04
header:
  caption: 'Photo credit: **M. T. Hallworth**'
  image: assets/images/lookingUp.jpg
layout: single
permalink: /_pages/projections
sidebar:
  nav: SpatialWorkshop
  title: Get Spatial! Using R as GIS
contributor: Clark_S_Rushing
---
{% include toc title="In This Activity" %}

<a name="TOP"></a>

This activity will introduce you projecting spatial data R.

**R Skill Level:** Intermediate - this activity assumes you have a working knowledge of `R` 


<div style="background-color:rgba(0, 0, 0, 0.0470588); border-radius: 25px; text-align:center; vertical-align: middle; padding:3px 0; width: 600px; margin: auto; box-shadow: 4px 5px gray;">

<h1>Objectives & Goals</h1>      
<b>Upon completion of this activity, you will:</b>
<ul>
<li>know <strong>how</strong> and <strong>why</strong> to project data </li>  
<li>know where to <strong>find</strong> projection definitions</li>
<li>know how <strong>assign</strong> projections </li>
<li>know how to <strong>project</strong> spatial data</li>
</ul>
</div>

<br>
<br>
<a name="install.packages"></a>
<div style="background-color:rgba(0, 1, 1, 0.0470588); border-radius: 25px; text-align:center; vertical-align: middle; padding:2px 0; width: 600px; margin: auto; box-shadow: 4px 5px gray;">
<h3> Required packages</h3> 
To complete the following activity you will need the following packages installed:

<strong>raster</strong>               
<strong>sp</strong>     
<strong>rgeos</strong>        
  
<h4>Installing the packages</h4>     
If installing these packages for the first time consider adding <code>dependencies=TRUE</code>    
<li><code>install.packages("raster",dependencies = TRUE)</code></li>
<li><code>install.packages("rgdal",dependencies = TRUE)</code></li>
<li><code>install.packages("rgeos",dependencies = TRUE)</code></li>
<li><code>install.packages("sp",dependencies = TRUE)</code></li>
</div>
        
<br>
<hr> 

# Projections
The reason we need projections is so that we can map a three dimensional surface - like the earth in two dimensional space. Unfortunately, not all properties of the 3D surface are maintained when plotting in 2D space. Attributes of the 3D surface such as area, distance, shape and direction are distorted when creating a 2D map. Projections define the way we distort the 3D surface in order to render it in 2D. The projection is the mathmatical equation used to 'flatten' the world. Every time we create a map we distort the true surface in some fashion. Different projections preserve different aspects of the 3D properties. Therefore, knowing which projections to use is important when doing spatial analyses. For example, if you're looking to create a map that looks 'correct' a conformal projection might be used as these types of projections preserve shape. If you're looking to make accurate distance measurements on a surface projections in the equidistant class are appropriate. Take a look at this <a href = "http://projections.mgis.psu.edu/" target="_blank">interactive map</a> that shows different projections - be sure to turn on the distortion ellipse so you can see how distortion changes. 

```{r, width = 6,echo = FALSE}
par(mar = c(0,0,2,0),mfrow = c(2,2))
world <- raster::shapefile("../Spatial_Layers/TM_WORLD_BORDERS-0.3.shp")
graticules <- sp::gridlines(world, easts = seq(-180,180,10), norths = seq(-90,90,10))
raster::plot(graticules, col = "gray80",main = "WGS84")
raster::plot(world,col = "gray70",add = TRUE)


worldROB <- sp::spTransform(world,sp::CRS("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
graticulesROB <- sp::spTransform(graticules,sp::CRS("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
raster::plot(graticulesROB, col = "gray80", main = "Robinson")
raster::plot(worldROB, add = TRUE, col = "gray70")

worldMOLL <- sp::spTransform(world,sp::CRS("+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
graticulesMOLL <- sp::spTransform(graticules,sp::CRS("+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
raster::plot(graticulesMOLL, col = "gray80",main = "Mollewide")
raster::plot(worldMOLL, col = "gray70", add = TRUE)

worldConic <- sp::spTransform(world, sp::CRS("+proj=aea +lat_1=50 +lat_2=90 +lat_0=-90 +lon_0=-10 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"))
graticulesConic <- sp::spTransform(graticules, sp::CRS("+proj=aea +lat_1=50 +lat_2=90 +lat_0=-90 +lon_0=-10 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"))
raster::plot(graticulesConic, col = "gray80",main = "Albers Equal Area")
raster::plot(worldConic, col = "gray70", add = TRUE)
```

<strong> Area of Greenland </strong>

|Projection| Area |
|---------|------|
|WGS84 (unproj)|`r rgeos::gArea(world[world$NAME=="Greenland",])`|
|Mollewide |`r rgeos::gArea(worldMOLL[worldMOLL$NAME == "Greenland",])/10000`|
|Robinson | `r rgeos::gArea(worldROB[worldROB$NAME == "Greenland",])/10000`|
|Albers Eq Area |`r rgeos::gArea(worldConic[worldConic$NAME == "Greenland",])/10000`|

Projecting data in R isn't done automatically (for the most part) like it is in ArcMap (on the fly). That means that we need to:
<ul>
<li> <strong>know the projection</strong> of all spatial layers &</li>
<li> be sure they <strong>match</strong> </li>
</ul>

### Finding projection definitions
<a name="FindProj"></a>
Each projection has a set of 'instructions' on how to distort the earth. For a detailed explaination of each parameter in a `coordinate reference system` (crs) see <a href = "http://proj4.org/parameters.html" target="_blank">proj4.org </a>.<br>

Below are some of my 'go to' sites for finding projection definitions. 
<ui>
<li><a href = "http://spatialreference.org/" target="_blank"><strong>spatialreference.org</strong></a></li><br>
<li><a href = "http://proj4.org/projections/index.html" target="_blank"><strong>proj4.org</strong></a></li><br>
<li><a href = "http://www.epsg-registry.org/" target="_blank"><strong>EPSG-registry.org</strong></a></li><br>
<li><a href = "http://spatialreference.org/ref/epsg/" target="_blank"><strong>EPSG-registry.org</strong></a></li><br>
</ui>

## Projecting spatial data

The good news is that it's quite simple to project spatial data in `R`. First, we need to know whether an object has a `coordinate reference system` (crs) or not. For the next few examples we'll use a `SpatialPolygonDataFrame` that we can get through the `raster` package. 
```{r get-polys,eval = FALSE, warning = FALSE,message = FALSE,error = FALSE}
States <- raster::getData(name = "GADM",
                             country = "United States",
                             level = 1,
                             path = "path/to/save/file",
                             download = TRUE)
# Take a look at the shapefile
States

# Let's remove Alaska and Hawaii for plotting purposes
States <- States[States$NAME_1 != "Alaska" & States$NAME_1 != "Hawaii",]
```

```{r read-states,echo = FALSE,message = FALSE,warning = FALSE}
library(raster)
library(rgdal)

States <- readRDS("../Spatial_Layers/GADM_2.8_USA_adm1.rds")
States
States <- States[States$NAME_1 != "Alaska" & States$NAME_1 != "Hawaii",]
```

### Access projection of object
You can find the projection information under the `coord. ref.` field above. To access the coordinate reference system within the object you can do one of the following:
```{r get-crs}
# Use the crs() function in raster
raster::crs(States)

# access the projection slot directly
States@proj4string

# access projection as character 
# - this can be very useful when 
#   using the projection of one
#   object to project another
States@proj4string@projargs
```

### Projection using `sp` package
Projecting data in `R` is very straightforward. The `spTransform` function found in the `sp` package makes projecting `Spatial` objects possible with only a single line of code. Let's change the projection from WGS84 into North America Lambert Equal Area. See [where to find projections](#FindProj) for where to find a definition for the North America Lambert Equal Area projection. There are two ways to assign the projection. First is to include a string of the <a href = "proj4.org" target="_blank">proj4</a> definition. The second is to refer to the ESPG authority number. Best practice is to use the ESPG code because the database is updated and if changes occur to the projection it will update your map accordingly if you re-run the code. Providing a character string of the projection does will not automatically update unless you manually go back and change the values. One benefit to using a character string (in my opinion) is that it's easy to manually create new projections with different central maridens that likely aren't predefined. 

```{r project-EqArea}
# Define the proj4 string 
EqArea <- "+proj=aea 
           +lat_1=20 +lat_2=60 +lat_0=40 +lon_0=-96 +x_0=0 +y_0=0 
           +ellps=GRS80 
           +datum=NAD83 
           +units=m +no_defs"

# project using the string
States_EqArea2 <- sp::spTransform(x = States,
                                 CRSobj = CRS(EqArea))

# project using the ESPG authority number
States_EqArea1 <- sp::spTransform(x = States,
                                 CRS("+init=ESRI:102008"))
```

```{r, echo = FALSE,fig.width = 6}
par(mar = c(0,0,2,0),mfrow = c(1,2))
raster::plot(States_EqArea1, col = "gray70",border = "white",main = "States_EqArea1")
raster::plot(States_EqArea2, col = "gray70",border = "white",main = "States_EqArea2")
```

Let's remove the `coordinate reference system` (crs) from `States` then try to project it and see what happens. 
```{r remove-crs}
crs(States)<-NA
States
```
### Defining projection to `SpatialObject`

If your `SpatialObject` doesn't have a `coordinate reference system` (crs) defined it won't know how to project the data. Therefore, if the `coordinate reference system` (crs) is `NA` you need to assign it. <strong>A word of caution</strong> - `R` will let you assign any valid PROJ.4 CRS string as the `coordinate reference system` to an object even if it doesn't make sense.   
```{r}
# Let's take a look at the extent of the 
# shapefile to give us a clue to what projection
# it may be. 
States
```

The `States` object appears to have a `+proj=longlat` since the extent of the object is in degrees longitude, latitude. Below we'll assign the WGS84 projection. 
```{r}
# Define WGS84 in proj4 string format
WGS84 <- "+proj=longlat +datum=WGS84 
          +no_defs +ellps=WGS84 +towgs84=0,0,0"

# use the crs() function in the raster package
# to define the projection
crs(States) <- WGS84

# take a look
States
```

## Projecting Rasters
